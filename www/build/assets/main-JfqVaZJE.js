const f=d=>{document.readyState==="loading"?document.addEventListener("DOMContentLoaded",d):d()};class g extends EventTarget{constructor(t){super(),this.naja=t,this.selector=".ajax",this.allowedOrigins=[window.location.origin],this.handler=this.handleUI.bind(this),t.addEventListener("init",this.initialize.bind(this))}initialize(){f(()=>this.bindUI(window.document.body)),this.naja.snippetHandler.addEventListener("afterUpdate",t=>{const{snippet:e}=t.detail;this.bindUI(e)})}bindUI(t){const e=`a${this.selector}`,i=a=>{a.removeEventListener("click",this.handler),a.addEventListener("click",this.handler)};if(t.matches(e))return i(t);t.querySelectorAll(e).forEach(a=>i(a));const s=a=>{a.removeEventListener("submit",this.handler),a.addEventListener("submit",this.handler)};if(t instanceof HTMLFormElement)return s(t);t.querySelectorAll("form").forEach(a=>s(a))}handleUI(t){const e=t.currentTarget,i=this.naja.prepareOptions(),n=()=>{};if(t instanceof MouseEvent){if(t.altKey||t.ctrlKey||t.shiftKey||t.metaKey||t.button)return;this.clickElement(e,i,t).catch(n);return}const{submitter:s}=t;(this.selector===""||e.matches(this.selector)||s!=null&&s.matches(this.selector))&&this.submitForm(s??e,i,t).catch(n)}async clickElement(t,e={},i){if(t instanceof HTMLAnchorElement)return this.processInteraction(t,"GET",t.href,null,e,i);if((t instanceof HTMLInputElement||t instanceof HTMLButtonElement)&&t.form)return this.submitForm(t,e,i);throw new Error("Unsupported element in clickElement(): element must be an anchor or a submitter element attached to a form.")}async submitForm(t,e={},i){let n,s=null;if((t instanceof HTMLInputElement||t instanceof HTMLButtonElement)&&t.form)n=t.form,s=t;else if(t instanceof HTMLFormElement)n=t,s=i instanceof SubmitEvent?i.submitter:null;else throw new Error("Unsupported element in submitForm(): formOrSubmitter must be either a form or a submitter element attached to a form.");const r=((s==null?void 0:s.getAttribute("formmethod"))??n.getAttribute("method")??"GET").toUpperCase(),a=(s==null?void 0:s.getAttribute("formaction"))??n.getAttribute("action")??window.location.pathname+window.location.search,o=new FormData(n,s);return this.processInteraction(s??n,r,a,o,e,i)}async processInteraction(t,e,i,n=null,s={},r){if(!this.dispatchEvent(new CustomEvent("interaction",{cancelable:!0,detail:{element:t,originalEvent:r,options:s}})))return r==null||r.preventDefault(),{};if(!this.isUrlAllowed(`${i}`))throw new Error(`Cannot dispatch async request, URL is not allowed: ${i}`);return r==null||r.preventDefault(),this.naja.makeRequest(e,i,n,s)}isUrlAllowed(t){const e=new URL(t,location.href);return e.origin==="null"?!1:this.allowedOrigins.includes(e.origin)}}class S{constructor(t){this.naja=t,t.addEventListener("init",this.initialize.bind(this)),t.uiHandler.addEventListener("interaction",this.processForm.bind(this))}initialize(){f(()=>this.initForms(window.document.body)),this.naja.snippetHandler.addEventListener("afterUpdate",t=>{const{snippet:e}=t.detail;this.initForms(e)})}initForms(t){const e=this.netteForms||window.Nette;if(!e)return;if(t instanceof HTMLFormElement){e.initForm(t);return}t.querySelectorAll("form").forEach(n=>e.initForm(n))}processForm(t){const{element:e,originalEvent:i}=t.detail,n=e instanceof HTMLFormElement,s=(e instanceof HTMLInputElement||e instanceof HTMLButtonElement)&&e.form;s&&(e.form["nette-submittedBy"]=e);const r=this.netteForms||window.Nette;(n||s)&&r&&!r.validateForm(e)&&(i==null||i.stopImmediatePropagation(),i==null||i.preventDefault(),t.preventDefault())}}class v extends EventTarget{constructor(t){super(),this.naja=t,t.uiHandler.addEventListener("interaction",e=>{var s,r;const{element:i,options:n}=e.detail;if(i.hasAttribute("data-naja-force-redirect")||(s=i.form)!=null&&s.hasAttribute("data-naja-force-redirect")){const a=i.getAttribute("data-naja-force-redirect")??((r=i.form)==null?void 0:r.getAttribute("data-naja-force-redirect"));n.forceRedirect=a!=="off"}}),t.addEventListener("success",e=>{const{payload:i,options:n}=e.detail;i.redirect&&(this.makeRedirect(i.redirect,n.forceRedirect??!1,n),e.stopImmediatePropagation())}),this.locationAdapter={assign:e=>window.location.assign(e)}}makeRedirect(t,e,i={}){t instanceof URL&&(t=t.href);let n=e||!this.naja.uiHandler.isUrlAllowed(t);this.dispatchEvent(new CustomEvent("redirect",{cancelable:!0,detail:{url:t,setUrl(r){t=r},isHardRedirect:n,setHardRedirect(r){n=!!r},options:i}}))&&(n?this.locationAdapter.assign(t):this.naja.makeRequest("GET",t,null,i))}}class b extends EventTarget{constructor(t){super(),this.op={replace:{updateElement(e,i){e.innerHTML=i},updateIndex(e,i){return i}},prepend:{updateElement(e,i){e.insertAdjacentHTML("afterbegin",i)},updateIndex(e,i){return i+e}},append:{updateElement(e,i){e.insertAdjacentHTML("beforeend",i)},updateIndex(e,i){return e+i}}},t.addEventListener("success",e=>{const{options:i,payload:n}=e.detail;n.snippets&&this.updateSnippets(n.snippets,!1,i)})}static findSnippets(t,e=window.document){const i={};return e.querySelectorAll('[id^="snippet-"]').forEach(s=>{((t==null?void 0:t(s))??!0)&&(i[s.id]=s.innerHTML)}),i}async updateSnippets(t,e=!1,i={}){await Promise.all(Object.keys(t).map(async n=>{const s=document.getElementById(n);s&&await this.updateSnippet(s,t[n],e,i)}))}async updateSnippet(t,e,i,n){let s=this.op.replace;if((t.hasAttribute("data-naja-snippet-prepend")||t.hasAttribute("data-ajax-prepend"))&&!i?s=this.op.prepend:(t.hasAttribute("data-naja-snippet-append")||t.hasAttribute("data-ajax-append"))&&!i&&(s=this.op.append),!this.dispatchEvent(new CustomEvent("beforeUpdate",{cancelable:!0,detail:{snippet:t,content:e,fromCache:i,operation:s,changeOperation(o){s=o},options:n}})))return;this.dispatchEvent(new CustomEvent("pendingUpdate",{detail:{snippet:t,content:e,fromCache:i,operation:s,options:n}})),await(typeof s=="function"?s:s.updateElement)(t,e),this.dispatchEvent(new CustomEvent("afterUpdate",{detail:{snippet:t,content:e,fromCache:i,operation:s,options:n}}))}}const y=Symbol();class p extends EventTarget{constructor(t){super(),this.naja=t,this.initialized=!1,this.cursor=0,this.popStateHandler=this.handlePopState.bind(this),t.addEventListener("init",this.initialize.bind(this)),t.addEventListener("before",this.saveUrl.bind(this)),t.addEventListener("before",this.saveOriginalTitle.bind(this)),t.addEventListener("before",this.replaceInitialState.bind(this)),t.addEventListener("success",this.pushNewState.bind(this)),t.redirectHandler.addEventListener("redirect",this.saveRedirectedUrl.bind(this)),t.uiHandler.addEventListener("interaction",this.configureMode.bind(this)),this.historyAdapter={replaceState:(e,i,n)=>window.history.replaceState(e,i,n),pushState:(e,i,n)=>window.history.pushState(e,i,n)}}set uiCache(t){console.warn("Naja: HistoryHandler.uiCache is deprecated, use options.snippetCache instead."),this.naja.defaultOptions.snippetCache=t}handlePopState(t){const{state:e}=t;if((e==null?void 0:e.source)!=="naja")return;const i=e.cursor-this.cursor;this.cursor=e.cursor;const n=this.naja.prepareOptions();this.dispatchEvent(new CustomEvent("restoreState",{detail:{state:e,direction:i,options:n}}))}initialize(){window.addEventListener("popstate",this.popStateHandler)}saveOriginalTitle(t){const{options:e}=t.detail;e[y]=window.document.title}saveUrl(t){const{url:e,options:i}=t.detail;i.href??(i.href=e)}saveRedirectedUrl(t){const{url:e,options:i}=t.detail;i.href=e}replaceInitialState(t){const{options:e}=t.detail;p.normalizeMode(e.history)!==!1&&!this.initialized&&(f(()=>this.historyAdapter.replaceState(this.buildState(window.location.href,"replace",this.cursor,e),window.document.title,window.location.href)),this.initialized=!0)}configureMode(t){var n,s;const{element:e,options:i}=t.detail;if(e.hasAttribute("data-naja-history")||(n=e.form)!=null&&n.hasAttribute("data-naja-history")){const r=e.getAttribute("data-naja-history")??((s=e.form)==null?void 0:s.getAttribute("data-naja-history"));i.history=p.normalizeMode(r)}}static normalizeMode(t){return t==="off"||t===!1?!1:t==="replace"?"replace":!0}pushNewState(t){const{payload:e,options:i}=t.detail,n=p.normalizeMode(i.history);if(n===!1)return;e.postGet&&e.url&&(i.href=e.url);const s=n==="replace"?"replaceState":"pushState",r=n==="replace"?this.cursor:++this.cursor,a=this.buildState(i.href,n,r,i),o=window.document.title;window.document.title=i[y],this.historyAdapter[s](a,o,i.href),window.document.title=o}buildState(t,e,i,n){const s={source:"naja",cursor:i,href:t};return this.dispatchEvent(new CustomEvent("buildState",{detail:{state:s,operation:e==="replace"?"replaceState":"pushState",options:n}})),s}}class l extends EventTarget{constructor(t){super(),this.naja=t,this.currentSnippets=new Map,this.storages={off:new A(t),history:new C,session:new L},t.addEventListener("init",this.initializeIndex.bind(this)),t.snippetHandler.addEventListener("pendingUpdate",this.updateIndex.bind(this)),t.uiHandler.addEventListener("interaction",this.configureCache.bind(this)),t.historyHandler.addEventListener("buildState",this.buildHistoryState.bind(this)),t.historyHandler.addEventListener("restoreState",this.restoreHistoryState.bind(this))}resolveStorage(t){let e;return t===!0||t===void 0?e="history":t===!1?e="off":e=t,this.storages[e]}static shouldCacheSnippet(t){return!t.hasAttribute("data-naja-history-nocache")&&!t.hasAttribute("data-history-nocache")&&(!t.hasAttribute("data-naja-snippet-cache")||t.getAttribute("data-naja-snippet-cache")!=="off")}initializeIndex(){f(()=>{const t=b.findSnippets(l.shouldCacheSnippet);this.currentSnippets=new Map(Object.entries(t))})}updateIndex(t){const{snippet:e,content:i,operation:n}=t.detail;if(!l.shouldCacheSnippet(e))return;const s=this.currentSnippets.get(e.id)??"",r=typeof n=="object"?n.updateIndex:()=>i;this.currentSnippets.set(e.id,r(s,i));const a=l.parser.parseFromString(i,"text/html"),o=b.findSnippets(l.shouldCacheSnippet,a);for(const[m,c]of Object.entries(o))this.currentSnippets.set(m,c)}configureCache(t){var n,s,r,a;const{element:e,options:i}=t.detail;if(e&&(e.hasAttribute("data-naja-snippet-cache")||(n=e.form)!=null&&n.hasAttribute("data-naja-snippet-cache")||e.hasAttribute("data-naja-history-cache")||(s=e.form)!=null&&s.hasAttribute("data-naja-history-cache"))){const o=e.getAttribute("data-naja-snippet-cache")??((r=e.form)==null?void 0:r.getAttribute("data-naja-snippet-cache"))??e.getAttribute("data-naja-history-cache")??((a=e.form)==null?void 0:a.getAttribute("data-naja-history-cache"));i.snippetCache=o}}buildHistoryState(t){const{state:e,options:i}=t.detail;"historyUiCache"in i&&(console.warn("Naja: options.historyUiCache is deprecated, use options.snippetCache instead."),i.snippetCache=i.historyUiCache);const n=Object.keys(b.findSnippets(l.shouldCacheSnippet)),s=Object.fromEntries(Array.from(this.currentSnippets).filter(([a])=>n.includes(a)));if(!this.dispatchEvent(new CustomEvent("store",{cancelable:!0,detail:{snippets:s,state:e,options:i}})))return;const r=this.resolveStorage(i.snippetCache);e.snippets={storage:r.type,key:r.store(s)}}restoreHistoryState(t){const{state:e,options:i}=t.detail;if(e.snippets===void 0||(i.snippetCache=e.snippets.storage,!this.dispatchEvent(new CustomEvent("fetch",{cancelable:!0,detail:{state:e,options:i}}))))return;const s=this.resolveStorage(i.snippetCache).fetch(e.snippets.key,e,i);s!==null&&this.dispatchEvent(new CustomEvent("restore",{cancelable:!0,detail:{snippets:s,state:e,options:i}}))&&this.naja.snippetHandler.updateSnippets(s,!0,i)}}l.parser=new DOMParser;class A{constructor(t){this.naja=t,this.type="off"}store(){return null}fetch(t,e,i){return this.naja.makeRequest("GET",e.href,null,{...i,history:!1,snippetCache:!1}),null}}class C{constructor(){this.type="history"}store(t){return t}fetch(t){return t}}class L{constructor(){this.type="session"}store(t){const e=Math.random().toString(36).substring(2,8);return window.sessionStorage.setItem(e,JSON.stringify(t)),e}fetch(t){const e=window.sessionStorage.getItem(t);return e===null?null:JSON.parse(e)}}class w{constructor(t){this.naja=t,this.loadedScripts=new Set,t.addEventListener("init",this.initialize.bind(this))}initialize(){f(()=>{document.querySelectorAll("script[data-naja-script-id]").forEach(t=>{const e=t.getAttribute("data-naja-script-id");e!==null&&e!==""&&this.loadedScripts.add(e)})}),this.naja.snippetHandler.addEventListener("afterUpdate",t=>{const{content:e}=t.detail;this.loadScripts(e)})}loadScripts(t){if(typeof t=="string"){this.loadScriptsInSnippet(t);return}Object.keys(t).forEach(e=>{const i=t[e];this.loadScriptsInSnippet(i)})}loadScriptsInSnippet(t){if(!/<script/i.test(t))return;w.parser.parseFromString(t,"text/html").querySelectorAll("script").forEach(n=>{const s=n.getAttribute("data-naja-script-id");if(s!==null&&s!==""&&this.loadedScripts.has(s))return;const r=window.document.createElement("script");if(r.innerHTML=n.innerHTML,n.hasAttributes())for(const a of n.attributes)r.setAttribute(a.name,a.value);window.document.head.appendChild(r).parentNode.removeChild(r),s!==null&&s!==""&&this.loadedScripts.add(s)})}}w.parser=new DOMParser;class j extends EventTarget{constructor(t,e,i,n,s,r,a){super(),this.VERSION=3,this.initialized=!1,this.extensions=[],this.defaultOptions={},this.uiHandler=new(t??g)(this),this.redirectHandler=new(e??v)(this),this.snippetHandler=new(i??b)(this),this.formsHandler=new(n??S)(this),this.historyHandler=new(s??p)(this),this.snippetCache=new(r??l)(this),this.scriptLoader=new(a??w)(this)}registerExtension(t){this.initialized&&t.initialize(this),this.extensions.push(t)}initialize(t={}){if(this.initialized)throw new Error("Cannot initialize Naja, it is already initialized.");this.defaultOptions=this.prepareOptions(t),this.extensions.forEach(e=>e.initialize(this)),this.dispatchEvent(new CustomEvent("init",{detail:{defaultOptions:this.defaultOptions}})),this.initialized=!0}prepareOptions(t){return{...this.defaultOptions,...t,fetch:{...this.defaultOptions.fetch,...t==null?void 0:t.fetch}}}async makeRequest(t,e,i=null,n={}){typeof e=="string"&&(e=new URL(e,location.href)),n=this.prepareOptions(n);const s=new Headers(n.fetch.headers||{}),r=this.transformData(e,t,i),a=new AbortController,o=new Request(e.toString(),{credentials:"same-origin",...n.fetch,method:t,headers:s,body:r,signal:a.signal});if(o.headers.set("X-Requested-With","XMLHttpRequest"),o.headers.set("Accept","application/json"),!this.dispatchEvent(new CustomEvent("before",{cancelable:!0,detail:{request:o,method:t,url:e.toString(),data:i,options:n}})))return{};const m=window.fetch(o);this.dispatchEvent(new CustomEvent("start",{detail:{request:o,promise:m,abortController:a,options:n}}));let c,u;try{if(c=await m,!c.ok)throw new H(c);u=await c.json()}catch(h){if(h.name==="AbortError")return this.dispatchEvent(new CustomEvent("abort",{detail:{request:o,error:h,options:n}})),this.dispatchEvent(new CustomEvent("complete",{detail:{request:o,response:c,payload:void 0,error:h,options:n}})),{};throw this.dispatchEvent(new CustomEvent("error",{detail:{request:o,response:c,error:h,options:n}})),this.dispatchEvent(new CustomEvent("complete",{detail:{request:o,response:c,payload:void 0,error:h,options:n}})),h}return this.dispatchEvent(new CustomEvent("payload",{detail:{request:o,response:c,payload:u,options:n}})),this.dispatchEvent(new CustomEvent("success",{detail:{request:o,response:c,payload:u,options:n}})),this.dispatchEvent(new CustomEvent("complete",{detail:{request:o,response:c,payload:u,error:void 0,options:n}})),u}appendToQueryString(t,e,i){if(i!=null)if(Array.isArray(i)||Object.getPrototypeOf(i)===Object.prototype)for(const[n,s]of Object.entries(i))this.appendToQueryString(t,`${e}[${n}]`,s);else t.append(e,String(i))}transformData(t,e,i){const n=["GET","HEAD"].includes(e.toUpperCase());if(n&&i instanceof FormData){for(const[r,a]of i)a!=null&&t.searchParams.append(r,String(a));return null}if(i!==null&&Object.getPrototypeOf(i)===Object.prototype||Array.isArray(i)){const r=n?t.searchParams:new URLSearchParams;for(const[a,o]of Object.entries(i))this.appendToQueryString(r,a,o);return n?null:r}return i}}class H extends Error{constructor(t){const e=`HTTP ${t.status}: ${t.statusText}`;super(e),this.name=this.constructor.name,this.stack=new Error(e).stack,this.response=t}}class T{constructor(){this.abortControllers=new Set}initialize(t){t.uiHandler.addEventListener("interaction",this.checkAbortable.bind(this)),t.addEventListener("init",this.onInitialize.bind(this)),t.addEventListener("start",this.saveAbortController.bind(this)),t.addEventListener("complete",this.removeAbortController.bind(this))}onInitialize(){document.addEventListener("keydown",t=>{if(t.key==="Escape"&&!(t.ctrlKey||t.shiftKey||t.altKey||t.metaKey)){for(const e of this.abortControllers)e.abort();this.abortControllers.clear()}})}checkAbortable(t){var n,s;const{element:e,options:i}=t.detail;(e.hasAttribute("data-naja-abort")||(n=e.form)!=null&&n.hasAttribute("data-naja-abort"))&&(i.abort=(e.getAttribute("data-naja-abort")??((s=e.form)==null?void 0:s.getAttribute("data-naja-abort")))!=="off")}saveAbortController(t){const{abortController:e,options:i}=t.detail;i.abort!==!1&&(this.abortControllers.add(e),i.clearAbortExtension=()=>this.abortControllers.delete(e))}removeAbortController(t){const{options:e}=t.detail;e.abort!==!1&&e.clearAbortExtension&&e.clearAbortExtension()}}class U{constructor(){this.abortControllers=new Map}initialize(t){t.uiHandler.addEventListener("interaction",this.checkUniqueness.bind(this)),t.addEventListener("start",this.abortPreviousRequest.bind(this)),t.addEventListener("complete",this.clearRequest.bind(this))}checkUniqueness(t){var n,s;const{element:e,options:i}=t.detail;if(e.hasAttribute("data-naja-unique")??((n=e.form)==null?void 0:n.hasAttribute("data-naja-unique"))){const r=e.getAttribute("data-naja-unique")??((s=e.form)==null?void 0:s.getAttribute("data-naja-unique"));i.unique=r==="off"?!1:r??"default"}}abortPreviousRequest(t){var n;const{abortController:e,options:i}=t.detail;i.unique!==!1&&((n=this.abortControllers.get(i.unique??"default"))==null||n.abort(),this.abortControllers.set(i.unique??"default",e))}clearRequest(t){const{request:e,options:i}=t.detail;!e.signal.aborted&&i.unique!==!1&&this.abortControllers.delete(i.unique??"default")}}const E=new j;E.registerExtension(new T);E.registerExtension(new U);document.addEventListener("DOMContentLoaded",()=>{E.initialize(),window.naja=E,console.log("Naja is ready!")});
